/*
 * generated by Xtext 2.13.0
 */
package org.xtext.distj14.generator

import org.eclipse.emf.ecore.resource.Resource
import org.eclipse.xtext.generator.AbstractGenerator
import org.eclipse.xtext.generator.IFileSystemAccess2
import org.eclipse.xtext.generator.IGeneratorContext
import org.xtext.distj14.math.MathExp
import org.xtext.distj14.math.Exp
import javax.swing.JOptionPane
import org.xtext.distj14.math.Plus
import org.xtext.distj14.math.Minus
import org.xtext.distj14.math.Primary
import org.xtext.distj14.math.Mult
import org.xtext.distj14.math.Div
import org.xtext.distj14.math.Factor

/**
 * Generates code from your model files on save.
 * 
 * See https://www.eclipse.org/Xtext/documentation/303_runtime_concepts.html#code-generation
 */
class MathGenerator extends AbstractGenerator {

override void doGenerate(Resource resource, IFileSystemAccess2 fsa, IGeneratorContext context) {
		val math = resource.allContents.filter(MathExp).next
		val result = math.compute
		System.out.println("Math expression = "+math.display)
		JOptionPane.showMessageDialog(null, "result = "+result,"Math Language", JOptionPane.INFORMATION_MESSAGE)
	}
	
	//
	// Compute function: computes value of expression
	// Note: written according to illegal left-recursive grammar, requires fix
	//
	
	def int compute(MathExp math) { 
		math.exp.computeExp
	}
	
	def int computeExp(Exp exp) {
		val left = exp.left.primary.computePrim
		
		if (exp.left?.operator !== null) {
			exp.left.computeFactor
		}
		
		switch exp.operator?.displayOp {
			case "+": left+exp.right.computeExp
			case "-": left-exp.right.computeExp
			default: left
		}
		
	}
	
	def int computeFactor(Factor factor) {
		val left = factor.primary.computePrim
		switch factor.operator?.displayOp {
			case "*": left*factor.second.primary.computePrim
			case "/": left/factor.second.primary.computePrim
			default: left
		}
	}
	
	
	def int computePrim(Primary factor) {
		factor.number.value
	}

	//
	// Display function: show complete syntax tree
	// Note: written according to illegal left-recursive grammar, requires fix
	//

	def CharSequence display(MathExp math) '''Math[«math.exp.displayExp»]'''
	def CharSequence displayExp(Exp exp) '''Exp[«exp.left.displayFactor»,«exp.operator?.displayOp»,«exp.right?.displayExp»]'''
	def dispatch String displayOp(Plus op)  { "+" }
	def dispatch String displayOp(Minus op) { "-" }
	def dispatch String displayOp(Mult op) { "*" }
	def dispatch String displayOp(Div op) { "/" }
	def CharSequence displayFactor(Factor factor) {'''Factor[«factor.primary.displayPrimary»,«factor?.displayOp»,«factor.second?.displayFactor»]'''}
	def CharSequence displayPrimary(Primary primary) { '''Primary[«primary?.number.value»]''' }
	
		
}
